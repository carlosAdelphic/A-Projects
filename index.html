<!DOCTYPE html>
<html>
<body>

<script type="text/javascript">
	
	var clickmacrord =  "${ADELPHIC_CLICK_REDIRECT_PROVIDED}";
	var clickmacronord =  "${ADELPHIC_CLICK_NOREDIRCT}";
	var clickmacronordenc = "${ADELPHIC_CLICK_NOREDIRECT_ENC}";
	var cbmacro = "${ADELPHIC_CACHE_BUSTER}";
	var finaltag = "";

	String.prototype.replaceAll = function(target, replacement) {
  		return this.split(target).join(replacement);
	};

	function addMacros (adserver, tag)
	{

		if (adserver == "Sizmek")
		{
			var cbm = tag.indexOf("\&ord");
			var cm = tag.indexOf("\&ncu");
			var px = tag.indexOf("script"); // if there's no "script" then we can assume they are pixels

			if (px == -1) // pixels have been input and no tags
			{
				if (tag.indexOf("Timestamp") != -1) {

					finaltag = tag.replaceAll("[Timestamp]", cbmacro);
				}
				else {

					finaltag = tag.replaceAll("[timestamp]", cbmacro);
				}

			}

			else{

				if (cbm != -1) // if the "ord" variable is already present in the tag 
				{
					var totph // variable to know the number of placeholders for the cb macro
					if (tag.indexOf("Timestamp") != -1) {

						totph = tag.match(/Timestamp/g).length; 
						finaltag = tag.replaceAll("[Timestamp]", cbmacro);
					}
					else {

						totph = tag.match(/timestamp/g).length; 
						finaltag = tag.replaceAll("[timestamp]", cbmacro);
					}

					//console.log(tag.match(/Timestamp/g).length);
					if (totph < 2) // if the "ord" variable is only present in the script part of the tag
					{
						var insertedcachebuster = "\&ord\="+cbmacro+"\&FlightID"
						finaltag = finaltag.replaceAll("\&FlightID", insertedcachebuster)
					}
					
					
				}

				else{ // no "ord" variable in the tag, so we add it

					var insertedcachebuster = "\&ord\="+cbmacro+"\&FlightID"
					finaltag = tag.replaceAll("\&FlightID", insertedcachebuster)
					var modtag = finaltag.split("\"\>\</script");
					finaltag = modtag[0]+"\&ord\="+cbmacro+"\"\>\<\/script"+modtag[1];


				}

				if (cm != -1) // if the clickmacro variable is already in the tag we replace the placeholder value
				{
					if (tag.indexOf("Click") != -1)
					finaltag = finaltag.replace("[Click]", clickmacronordenc)
					else if (tag.indexOf("click") != -1)
					finaltag = finaltag.replace("[click]", clickmacronordenc)

				}

				else{

						finaltag = finaltag.replace ("\"\>\</script", "\&ncu\=$$$$$"+clickmacronordenc+"$$$\"\<\/script");

				}
			}
		}

			

		else if (adserver == "Adform")
		{

			var cbm = tag.indexOf("\;ord");
			var cm = tag.indexOf("\;click");

			if (cbm != -1)
			{
				finaltag = tag.replaceAll("[timestamp]", cbmacro);
			}

			else{

				//Generally the cachebuster variable is there

			}

			if (cm != -1)
			{
				finaltag = finaltag.replace("click\=", "click\="+clickmacronordenc)
				var modtag = finaltag.split("\<a href\=\"");
				finaltag = modtag[0]+"\<a href\=\""+clickmacrord+"\}"+modtag[1];

			}

			else{
					var modtag = finaltag.split("\"\>\<\/script");
					finaltag = modtag[0]+"\;click\=\""+clickmacrord+"\"\>\<\/script"+modtag[1];
					modtag = finaltag.split("\<a href\=\"");
					finaltag = modtag[0]+"\<a href\=\""+clickmacrord+modtag[1];

			}
		}

	

			document.getElementById('tagwithmacros').value = finaltag;

		

	}


</script>

<h1>Adelphic Macro Injecter</h1>

<table style="width:600px">
  <tr>
    <td><p style="font-size:14px; vertical-align:middle;">Select ad-server: </p></td>
    <td><select name="adserver" id="adserver">
	<option value="Sizmek">Sizmek</option>
	<option value="Adform">Adform</option>
	</select></td> 
  </tr>
  <tr>
    <td><p style="font-size:14px">Insert tag/tracking pixel here: </p></td>
    <td><textarea name="tag" id="tag" style="vertical-align:top; width:470px; height:200px"></textarea></td> 
  </tr>
  <tr>
  	<td></td>
  	<td style="text-align: right"><button type="Insert" onclick="addMacros(document.getElementById('adserver').value, document.getElementById('tag').value)">Insert macros</button></td>
  </tr>
  <tr style="height: 40px"><td></td><td></td></tr>
  <tr>
  	<td><p style="font-size:14px">Tag/pixel with Adelphic macros: </p></td>
  	<td><textarea name="tagwithmacros" id="tagwithmacros" style="vertical-align:top; width:470px; height:200px"></textarea></td>
  </tr>
</table>


</body>
</html>